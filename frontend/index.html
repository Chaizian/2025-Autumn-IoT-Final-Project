<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>物联网环境监测系统</title>
    <!-- 换回更稳定的 CDN，或者你可以下载到本地 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.3.4/axios.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; background-color: #f4f4f9; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #333; }
        .controls { margin-bottom: 20px; text-align: center; }
        button { padding: 10px 20px; margin: 0 5px; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 4px; }
        button:hover { background-color: #0056b3; }
        button.active { background-color: #004494; font-weight: bold; }
        canvas { max-height: 400px; }
        .analysis-panel { margin-top: 20px; padding: 15px; background: #e9ecef; border-radius: 5px; display: none; }

        .analysis-cards {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }

        .card {
            flex: 1;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.05);
        }

        .card h3 {
            margin-top: 0;
            color: #333;
        }

        .status-card {
            border-left: 5px solid #17a2b8;
        }

        .risk-card {
            border-left: 5px solid #dc3545;
        }

        .risk-high {
            color: #dc3545;
            font-weight: bold;
        }

        .risk-medium {
            color: #fd7e14;
            font-weight: bold;
        }

        .risk-low {
            color: #28a745;
            font-weight: bold;
        }

        .ai-card {
            border-left: 5px solid #6f42c1;
        }
        
        .ai-content {
            white-space: pre-wrap;
            font-size: 0.95em;
            color: #444;
            background: #fff;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #eee;
            margin-top: 10px;
            min-height: 60px;
        }

        .btn-ai {
            background-color: #6f42c1;
            font-size: 0.8em;
            padding: 5px 10px;
            margin-left: 10px;
        }
        .btn-ai:hover { background-color: #59359a; }

    </style>
</head>
<body>

<div class="container">
    <h1>环境数据实时监测与分析</h1>
    
    <div class="controls">
        <button onclick="switchTab('temperature')" id="btn-temp" class="active">温度</button>
        <button onclick="switchTab('humidity')" id="btn-hum">湿度</button>
        <button onclick="switchTab('pressure')" id="btn-pres">气压</button>
    </div>

    <div class="controls">
        <label for="timeUnit">时间单位：</label>
        <select id="timeUnit" onchange="fetchData()">
            <option value="raw">原始数据点</option>
            <option value="hour">小时平均</option>
            <option value="day">天平均</option>
        </select>
    </div>

    <canvas id="mainChart"></canvas>

    <div class="analysis-cards">
        <div class="card status-card">
            <h3>环境状态分析</h3>
            <p id="status-overall">加载中...</p>
            <ul>
                <li>温热舒适度：<span id="status-thermal">-</span></li>
                <li>湿度状态：<span id="status-humidity">-</span></li>
                <li>气压趋势：<span id="status-pressure">-</span></li>
            </ul>
        </div>

        <div class="card risk-card">
            <h3>环境风险评估</h3>
            <p id="risk-level">加载中...</p>
            <p>置信度：<span id="risk-confidence">-</span></p>
            <p>原因：<span id="risk-reason">-</span></p>
        </div>
    </div>

    <div class="card ai-card" style="margin-top: 20px;">
        <h3> AI 智能建议 <button onclick="fetchAIAdvice()" class="btn-ai">分析</button></h3>
        <div id="ai-advice" class="ai-content">点击“分析”按钮获取 DeepSeek 智能建议...</div>
    </div>

    <div class="controls" style="margin-top: 20px;">
        <button onclick="togglePrediction()" style="background-color: #28a745;">显示/隐藏 预测分析</button>
    </div>

    <div id="analysis" class="analysis-panel">
        <h3>数据分析报告</h3>
        <p id="analysis-text">正在计算趋势...</p>
    </div>
</div>

<script>
    /* ================= 全局状态 ================= */

    let currentType = 'temperature';
    let chartInstance = null;
    let showPrediction = false;
    const API_URL = 'http://localhost:5000/api';

    /* ================= Chart 初始化 ================= */

    const ctx = document.getElementById('mainChart').getContext('2d');

    function initChart() {
        chartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    {
                        label: '实时数据',
                        data: [],
                        borderColor: '#007bff',
                        tension: 0.1,
                        fill: false
                    },
                    {
                        label: '预测趋势',
                        data: [],
                        borderColor: '#dc3545',
                        borderDash: [5, 5],
                        tension: 0.1,
                        fill: false,
                        hidden: true
                    }
                ]
            },
            options: {
                responsive: true,
                animation: false,
                scales: {
                    x: {
                        display: true,
                        title: { display: true, text: '时间' }
                    },
                    y: {
                        display: true,
                        title: {
                            display: true,
                            text: getYAxisLabel()
                        }
                    }
                }
            }
        });
    }

    /* ================= 交互逻辑 ================= */

    function switchTab(type) {
        currentType = type;

        document.querySelectorAll('.controls button')
            .forEach(b => b.classList.remove('active'));

        document.getElementById(
            type === 'temperature' ? 'btn-temp' :
                type === 'humidity' ? 'btn-hum' : 'btn-pres'
        ).classList.add('active');

        // 重置预测显示
        showPrediction = false;
        const btn = document.querySelector('button[onclick="togglePrediction()"]');
        btn.innerText = '显示 预测分析';
        btn.style.backgroundColor = '#28a745';

        document.getElementById('analysis').style.display = 'none';

        // 重建图表，避免坐标轴残留
        chartInstance.destroy();
        initChart();

        fetchData();
    }

    function getYAxisLabel() {
        if (currentType === 'temperature') return '温度 (°C)';
        if (currentType === 'humidity') return '湿度 (%)';
        if (currentType === 'pressure') return '气压 (hPa)';
        return '数值';
    }

    function togglePrediction() {
        showPrediction = !showPrediction;

        const btn = document.querySelector('button[onclick="togglePrediction()"]');

        if (showPrediction) {
            btn.innerText = '隐藏 预测分析';
            btn.style.backgroundColor = '#6c757d';
            fetchData(); // 立即刷新并预测
        } else {
            btn.innerText = '显示 预测分析';
            btn.style.backgroundColor = '#28a745';

            document.getElementById('analysis').style.display = 'none';
            chartInstance.data.datasets[1].hidden = true;
            chartInstance.update();
        }
    }

    /* ================= 数据获取 ================= */

    async function fetchData() {
        try {
            const unit = document.getElementById('timeUnit').value;
            const res = await axios.get(
                `${API_URL}/history?type=${currentType}&limit=50&group_by=${unit}`
            );

            const data = res.data;
            if (!data || data.length === 0) return;

            const labels = data.map(d => formatTimestamp(d.timestamp, unit));
            const values = data.map(d => d.value);

            chartInstance.data.labels = labels;
            chartInstance.data.datasets[0].data = values;
            chartInstance.data.datasets[0].label = `${currentType} 实时数据`;

            chartInstance.options.scales.y.title.text = getYAxisLabel();

            if (showPrediction) {
                await updatePrediction();
            } else {
                chartInstance.data.datasets[1].data = [];
            }

            chartInstance.update();

        } catch (e) {
            console.error('fetchData error:', e);
        }
    }

    /* ================= 预测逻辑 ================= */

    async function updatePrediction() {
        try {
            const res = await axios.get(`${API_URL}/predict`);
            const result = res.data;

            if (!result.prediction || !result.prediction[currentType]) return;

            const pred = result.prediction[currentType];
            const future = pred.future;
            const horizon = future.length;

            const realValues = chartInstance.data.datasets[0].data;
            const realLabels = chartInstance.data.labels;

            // 构造未来标签（仅用于展示）
            const lastLabel = realLabels[realLabels.length - 1];
            const futureLabels = [];

            for (let i = 1; i <= horizon; i++) {
                futureLabels.push(`${lastLabel} +${i}`);
            }

            chartInstance.data.labels = realLabels.concat(futureLabels);

            // 预测线：前面用 null 断开，仅显示未来走势
            chartInstance.data.datasets[1].data = new Array(realValues.length - 1).fill(null)
                .concat([realValues[realValues.length - 1]])
                .concat(future);
            chartInstance.data.datasets[1].hidden = false;

            updateAnalysisPanel(pred, result.overall_trend, horizon);
            chartInstance.update();

        } catch (e) {
            console.error('updatePrediction error:', e);
        }
    }

    /* ================= 分析面板 ================= */

    function updateAnalysisPanel(pred, overall, horizon) {
        const panel = document.getElementById('analysis');
        panel.style.display = 'block';

        document.getElementById('analysis-text').innerText =
            `预测趋势：${translateTrend(pred.trend)}，
当前值：${pred.current}，
未来 ${horizon} 个时间步预测完成。
综合判断：${translateOverall(overall)}`;
    }

    /* ================= 工具函数 ================= */

    function formatTimestamp(ts, unit) {
        if (unit === 'raw') return ts.replace('T', ' ');
        if (unit === 'hour') return ts.replace('T', ' ') + ':00';
        return ts;
    }

    function translateTrend(t) {
        if (t === 'RISING') return '上升';
        if (t === 'FALLING') return '下降';
        return '稳定';
    }

    function translateOverall(o) {
        if (o === 'POSSIBLE_WEATHER_CHANGE') return '可能出现天气变化';
        if (o === 'POSSIBLE_HEAT_DISCOMFORT') return '可能出现高温不适';
        return '环境稳定';
    }

    async function fetchEnvironmentStatus() {
        try {
            const res = await axios.get(`${API_URL}/environment/status`);
            const s = res.data;

            if (s.state === "INSUFFICIENT_DATA") {
                document.getElementById('status-overall').innerText = '数据不足';
                return;
            }

            document.getElementById('status-overall').innerText =
                `整体状态：${translateOverallState(s.overall_state)}`;

            document.getElementById('status-thermal').innerText =
                translateThermal(s.thermal_comfort);

            document.getElementById('status-humidity').innerText =
                translateHumidity(s.humidity_state);

            document.getElementById('status-pressure').innerText =
                translateTrend(s.pressure_trend);

        } catch (e) {
            console.error('status error:', e);
        }
    }

    async function fetchEnvironmentRisk() {
        try {
            const res = await axios.get(`${API_URL}/environment/risk`);
            const r = res.data;

            const levelEl = document.getElementById('risk-level');
            levelEl.innerText = `风险等级：${r.risk_level}`;

            levelEl.className = '';
            if (r.risk_level === 'HIGH') levelEl.classList.add('risk-high');
            if (r.risk_level === 'MEDIUM') levelEl.classList.add('risk-medium');
            if (r.risk_level === 'LOW') levelEl.classList.add('risk-low');

            document.getElementById('risk-confidence').innerText = r.confidence;
            document.getElementById('risk-reason').innerText = r.reason;

        } catch (e) {
            console.error('risk error:', e);
        }
    }

    function translateThermal(v) {
        if (v === 'HOT') return '偏热';
        if (v === 'COLD') return '偏冷';
        return '舒适';
    }

    function translateHumidity(v) {
        if (v === 'HUMID') return '潮湿';
        if (v === 'DRY') return '干燥';
        return '正常';
    }

    function translateOverallState(v) {
        if (v === 'DISCOMFORT') return '环境不舒适';
        if (v === 'WEATHER_CHANGE') return '可能天气变化';
        return '正常';
    }

    async function fetchAIAdvice() {
        const aiDiv = document.getElementById('ai-advice');
        aiDiv.innerText = "正在思考中...";
        try {
            const res = await axios.get(`${API_URL}/llm/advice`);
            aiDiv.innerText = res.data.advice;
        } catch (error) {
            console.error("Error fetching AI advice:", error);
            aiDiv.innerText = "获取建议失败，请检查后端连接。";
        }
    }


    /* ================= 启动 ================= */

    initChart();
    fetchData();
    setInterval(fetchData, 2000);

    fetchEnvironmentStatus();
    fetchEnvironmentRisk();

    setInterval(() => {
        fetchEnvironmentStatus();
        fetchEnvironmentRisk();
    }, 5000);
</script>

</body>
</html>
